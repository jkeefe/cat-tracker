# Process Notes on Cat-Tracker

This is my log and rough note-taking spot of how I'm going about this project.

## Concept

I want to play with machine learning, and I have an idea to play with data generated by my cat's location in my home.

## Getting the Pi Running

This time I'm trying the pi-management site [Resin.io](http://resin.io) to get my code on my pi, espcially since I hope to have three of these working to take measurements.

Following the instructions here: https://docs.resin.io/raspberrypi3/nodejs/getting-started/#adding-your-first-device

- Started new project: `cattracker`
- Downloaded image
- Using Etcher to put image on an SD card
- Now booting up the Pi -- ooh, this showed up in mere minutes


Instead of using [the example repo](https://github.com/resin-io-projects/simple-server-node), I made my own new repo.

- Synched it to resin with: `git remote add resin [me]@git.resin.io:j_f_keefe/cattracker.git`
- Then did `npm init`
- Then added, based on the example repo, but changing `server.js` to `index.js`: 
```
"scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "start": "node index.js"
  },
```
- Copied `Dockerfile.template` from [here](https://github.com/resin-io-projects/simple-server-node/blob/master/Dockerfile.template)
- Loaded up my ssh key with `ssh-add`
- Did `git push origin master` to save a copy in my main repo
- Did `git push resin master` to send it to the pi
- WORKS: Saved as branch `git push --set-upstream origin waypoint1-sucessful-setup`

## Periodic updates with CRON

Going to check out [this example code](https://github.com/resin-io-playground/cron-example/blob/master/Dockerfile.template).

## The Beacon

- Bought this: https://store.gimbal.com/collections/beacons/products/s10
- Had to pry it open, but managed to pull that off
- Signed up for a Gimbal account (which I did when I bought it)
- Logged in at https://manager.gimbal.com/
- Beacons > Beacon Management > Activate Beacon
- Put in the code from inside the beacon (which it turns out I could have scanned with the app)
- Downloaded the Gimbal Beacon Manager from the App Store
- To configure the beacon ... and make it stop broadcasting random IDs:
    - Open the Gimbal Beacon Manager on the iPhone
    - Then open the beacon and "remove" the battery and put it back
    - Snap the beacon back together
    - Now you can update the info on the beacon, and the firmware.
- Looking good!

## Scanning for Beacons

Working roughly from this [explainer](https://blog.truthlabs.com/beacon-tracking-with-node-js-and-raspberry-pi-794afa880318) ...

- Installed "Bluez" on the Pi using info from [this site](https://www.thepolyglotdeveloper.com/2016/09/scan-bluetooth-enabled-ibeacons-via-raspberry-pi-iot-device/).
- Need to add `sudo apt-get install bluez bluez-hcidump` into the Docker startup file, I think.
- Doing that by altering the commented-out example in `Dockerfile.template` so it looks like this:
```bash
RUN apt-get update && apt-get install -yq \
    bluez bluez-hcidump && \
    apt-get clean && rm -rf /var/lib/apt/lists/*
```
- Eeeps, need more than that. Got **"Set scan parameters failed: File descriptor in bad state"** whenever I tried anything. So tried some of what is outlined [here](https://www.raspberrypi.org/forums/viewtopic.php?f=63&t=141850):

```shell
sudo apt-get purge bluez-utils blueman bluez bluez-firmware pi-bluetooth
sudo apt-get install blueman bluez  # RPi 2
sudo apt-get install blueman bluez bluez-firmware pi-bluetooth  # RPi 3
sudo usermod -G bluetooth -a pi  # Or it won't work
cat /etc/group | grep bluetooth
sudo service bluetooth status

# Reboot

# Test
sudo service bluetooth status
rfkill list
sudo hcitool lescan
bluetoothctl
```

Took some tinkering, and some changes (like user `root` instead of `pi` but I implemented this like so in the `Dockerfile.template`:

```bash
RUN apt-get update && apt-get install -yq \
    blueman bluez bluez-firmware pi-bluetooth build-essential libbluetooth-dev libudev-dev && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

[other code here, see file]

RUN usermod -a -G bluetooth root && \
cat /etc/group | grep bluetooth
```

- Then I tested it with: `sudo hcitool lescan` ... and it worked!

## Scanning for Beacons Part II

In addition to the hardware scanning changes described ☝️, I needed to use some software in a language I know (somewhat), which would be node. So using the [noble](https://github.com/sandeepmistry/noble) library.

*** [This Getting Started document](https://github.com/sandeepmistry/noble/wiki/Getting-started) appears to be essential. Revised details in Part I accordingly.

Seems I was missing `libbluetooth-dev` particularly.

Installed nobel with:
```
npm install noble --save
```
Also used example javascript, and it worked beautifully.

But the cat was too far away in the kids' room!

Now we have him:
```
advertising: { localName: undefined,
  txPowerLevel: undefined,
  manufacturerData: <Buffer 8c 00 6e 99 58 f1 3b 8a 24 3c b5>,
  serviceData: [],
  serviceUuids: [ '960c4a90244c11e2b29900a0c60077ad' ],
  solicitationServiceUuids: [],
  serviceSolicitationUuids: [] }
rssi: -61
```

## RSSI Smoothing

The numbers are definitely all over the place, even when I put the beacon right next to the receiver. I noticed there was a "RSSI Smoothing" option in the Gimbal app, so looked into it for my processing.

Found [this description](https://www.wouterbulten.nl/blog/tech/kalman-filters-explained-removing-noise-from-rssi-signals/) of Kalman Filters, which included [description](https://www.wouterbulten.nl/blog/tech/lightweight-javascript-library-for-noise-filtering/) and [code](https://github.com/wouterbulten/kalmanjs) for a JavasScript library.

Probably will use the "Predicting Growth" section and play with the `A:` value. Or maybe not, if it's just a small sample and we assume the cat is "static" in a spot for that sample.

Maybe I push into an array a fixed number of samples, and when queried I just take the Kalman of wherever they are at at the moment.

## Data Collection

Have been thinking about the best way to synchronize the Pis, and decided that maybe I expose port 80 to them (using Resin's "public url" option) and just serve up JSON with the latest reading (with the Kalman filter).

- Do this with a lambda function
- Drive with a cron job
- Three promises that run with each run
- Store the data to S3? in an appended CSV? (Or DynamoDB?) Or Airtable? or Spark
- Heck, might just post it to a google spreadsheet?




